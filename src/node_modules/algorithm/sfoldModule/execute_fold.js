var Log = require('log').Log,
    utils = require('utils');
    
var SFOLD_COMMAND = utils.SFOLD_COMMAND;
var UNAFOLD_COMMAND = utils.UNAFOLD_COMMAND;

function Fold(){}



var SFOLD_CALL_NO_CONSTRAINT = SFOLD_COMMAND+" -o %OUTDIR% %SEQUENCEFILE%";
var SFOLD_CALL = SFOLD_COMMAND+" -f %CONSTRAINT% -o %OUTDIR% %SEQUENCEFILE%";

/*Takes in file containing multiple sequences separated by an endline*/
Fold.SFold = function( sequenceFile, targetFolder , reportObj ,constraintFile )
{
	Log('Started folding ' + sequenceFile, 'Fold.SFold', 7);
	var sys = require('sys')
	var exec = require('child_process').exec;
	var command = '';
	if(constraintFile ==undefined)
	{
		command = SFOLD_CALL_NO_CONSTRAINT
		.replace('%OUTDIR%',targetFolder)
		.replace('%SEQUENCEFILE%',sequenceFile);
	}
	else
	{
		command = SFOLD_CALL_NO_CONSTRAINT
		.replace('%OUTDIR%',targetFolder)
		.replace('%SEQUENCEFILE%',sequenceFile)
		.replace('%CONSTRAINT%',constraintFile);
	}
	exec(command, 
		function/* CommandExecuteCallback*/( error, stdout, stderr )
		{
			if(error !== null)
			{
				Log("Could not call sfold with " + sequenceFile + "," + targetFolder + "constraintFile", "Fold.SFold" , 0); 
			}
			
			Log("stdout sfold " + command + ": " + stdout , "SFold", 3);
			Log("stderr sfold " + command + ": " + stderr, "SFold", 0 );

			reportObj.FileCount =  reportObj.FileCount - 1;
			reportObj.ExecuteIfComplete(1);
		}
	);
	Log('Completed folding ' + sequenceFile, 'Fold.SFold', 7);
}



Fold.UnaFold = function ( file, options)
{

}



//Candidate
//	ID
//	cutsiteID
//	requestID
//	sequence
//	
//
Fold.ExecuteFolding = function(candidate, constraints, reportObj )
{
	Log('Executing fold of candidate ' + candidate.ID, 'Fold.ExecuteFolding',6);
	var fs = require('fs');
	var seqFile = candidate.requestID+'/'+candidate.cutsiteID + '/'+ candidate.ID +'.seq';
	fs.writeFileSync(seqFile,'> File for  ' + candidate.ID +'\n' +candidate.sequence );
	var newDir = candidate.requestID+'/'+candidate.cutsiteID + '/'+ candidate.ID + '/'
	fs.mkdirSync(newDir);
	Fold.SFold( seqFile , newDir, reportObj );
	Log('Completed executing fold of candidate ' + candidate.ID, 'Fold.ExecuteFolding',6);
}



//	cutSite : Id info
//		ID : Id of the cutsite
//		requestID : Id of the request
//  candidateArray : array of candidates to fold
//  reportObj : Master object that sees it all

Fold.FoldCandidates = function ( cutSite , candidateArray, reportObj)
{
	Log('Folding candidates for cutSite ' + cutSite.ID, 'Fold.FoldCandidates',5);
    var fs = require('fs');
	var newDir = cutSite.requestID+'/'+cutSite.ID ;
	fs.mkdirSync(newDir)
    //We need to wait untill all the candidates are folded
    reportObj.FileCount = candidateArray.length;
	for(var ii = 0; ii < candidateArray.length ; ++ii )
	{
		Fold.ExecuteFolding({'ID' :candidateArray[ii].ID, 'cutsiteID': cutSite.ID, 'requestID': cutSite.requestID, 'sequence':candidateArray[ii].Sequence },
					'',
					reportObj
					);
	}
	Log('Finished Folding candidates for cutSite ' + cutSite.ID, 'Fold.FoldCandidates',5);
}


var test = false;
if(test)
{
	Fold.FoldCandidates ( {'ID' : 'cutSite'+0, 'requestID':'test'}, ['UUA CUG GAA CUG AUG AGU CCG UGA GGA CGA A AC AUC UGG AGA'], {'FileCount':0}  ); 
	console.log('ex');
}
exports.Fold = Fold;
